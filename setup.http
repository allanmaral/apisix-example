### List Upstreams
GET {{$dotenv APISIX_ADMIN_URL}}/apisix/admin/upstreams HTTP/1.1
X-Api-Key: {{$dotenv APISIX_ADMIN_API_KEY}}



### Create an Upstream
PUT {{$dotenv APISIX_ADMIN_URL}}/apisix/admin/upstreams/1 HTTP/1.1
X-Api-Key: {{$dotenv APISIX_ADMIN_API_KEY}}
Content-Type: application/json

{
  "type": "roundrobin",
  "nodes": {
    "httpbin.org:80": 1
  }
}




### Create a Route
PUT {{$dotenv APISIX_ADMIN_URL}}/apisix/admin/routes/1 HTTP/1.1
X-Api-Key: {{$dotenv APISIX_ADMIN_API_KEY}}
Content-Type: application/json

{
  "methods": ["GET"],
  "host": "example.com",
  "uri": "/anything/*",
  "upstream_id": "1"
}

### Test created route
GET {{$dotenv BASE_URL}}/anything/get?foo=bar&baz=qux
Host: example.com

## Protecting api

### Create a new Route

PUT {{$dotenv APISIX_ADMIN_URL}}/apisix/admin/routes/2 HTTP/1.1
X-Api-Key: {{$dotenv APISIX_ADMIN_API_KEY}}
Content-Type: application/json

{
  "uri": "/index.html",
  "plugins": {
    "limit-count": {
      "count": 2,
      "time_window": 60,
      "rejected_code": 503,
      "key_type": "var",
      "key": "remote_addr"
    }
  },
  "upstream_id": "1"
}

### Test create route
GET {{$dotenv BASE_URL}}/index.html HTTP/1.1


# Observability

## Logs

### Create a new route using the http-logger plugin
PUT {{$dotenv APISIX_ADMIN_URL}}/apisix/admin/routes/3 HTTP/1.1
X-Api-Key: {{$dotenv APISIX_ADMIN_API_KEY}}
Content-Type: application/json

{
  "plugins": {
    "http-logger": {
      "uri": "https://30465e8b3fc641df84221c2e41c16581.api.mockbin.io/"
    }
  },
  "upstream_id": "1",
  "uri": "/get"
}

### Test logging
GET {{$dotenv BASE_URL}}/get?sample=hummm HTTP/1.1



## Metrics

### Update the previous route to use the prometheus plugin
PATCH {{$dotenv APISIX_ADMIN_URL}}/apisix/admin/routes/3 HTTP/1.1
X-Api-Key: {{$dotenv APISIX_ADMIN_API_KEY}}
Content-Type: application/json

{
  "plugins": {
    "prometheus": {}
  }
}

### Fetch metric data
GET http://mypi.local:9091/apisix/prometheus/metrics HTTP/1.1

# Keycloak

### Create API route
PUT {{$dotenv APISIX_ADMIN_URL}}/apisix/admin/routes/4 HTTP/1.1
X-Api-Key: {{$dotenv APISIX_ADMIN_API_KEY}}
Content-Type: application/json

{
  "plugins": {
    "openid-connect": {
      "discovery": "http://keycloak:8080/realms/apisix/.well-known/openid-configuration",
      "client_id": "apisix",
      "client_secret": "rjoVkMUDpUH4TE7IXhhJuof4O7OFrbph",
      "bearer_only": false,
      "scope": "openid",
      "realm": "apisix",
      "redirect_uri": "http://mypi.local@9080/anything/callback"
    }
  },
  "upstream_id": "1",
  "uri": "/anything/*"
}

### Test request
POST http://mypi.local:9009/realms/apisix/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=apisix&client_secret=rjoVkMUDpUH4TE7IXhhJuof4O7OFrbph&username=john&password=doe


### Test logging
GET {{$dotenv BASE_URL}}/anything/test HTTP/1.1
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJRWU8xd2RmbDZTZkRMOXVvczFGVjk5akUyMFVPNDlqaXI4SWFCTVhUdjVvIn0.eyJleHAiOjE3MDQ5NTExMjUsImlhdCI6MTcwNDk1MDgyNSwiYXV0aF90aW1lIjoxNzA0OTUwODI1LCJqdGkiOiJmODJkMGVhZC05NGVmLTQ4YTYtOWYyNi0wYjA5ZWE1ZTJiNWYiLCJpc3MiOiJodHRwOi8vbXlwaS5sb2NhbDo5MDA5L3JlYWxtcy9hcGlzaXgiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiZmJjODRlMGMtZjFiNi00ZDM2LTlmMzUtMmViMzAzNThkYjYzIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYXBpc2l4Iiwibm9uY2UiOiJmODIxZDgxODk4ZWZlMjhmMDhjMTRlODNlMDA5ZDE5NCIsInNlc3Npb25fc3RhdGUiOiJlZmI5MTk5MC1jZTJlLTRmOWQtOTFkOS03YTEyNmRmYWEwNzYiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImRlZmF1bHQtcm9sZXMtYXBpc2l4Iiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiIsInVzZXIiXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6Im9wZW5pZCBlbWFpbCBwcm9maWxlIiwic2lkIjoiZWZiOTE5OTAtY2UyZS00ZjlkLTkxZDktN2ExMjZkZmFhMDc2IiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJuYW1lIjoiSm9obiBEb2UiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJqb2huIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJmYW1pbHlfbmFtZSI6IkRvZSJ9.RwLMIEFuJqnc1_4M-2cnwnCcq_MELAZJ2q6l0l5lR-TToK-cwRahGWvU3J6Oz_jopEh5HPN59ib7NTpZuNtaDq0sqDf7reqEnHwkzqk6uY2tb5WLCAUxqL6XVEBMBNFPx9oAhkxk04fGIODUXBIrCB_T3-Vzv_9GblMRZw3M3ogi4cWu6TugyJAxDgWbfHQYA2W_7S4pbK71ZYxKkqwqDqhjcbxQwR_8VTnco9PLWHqof__mi3vgYK5Exup2TDtdH8CeulEAAf5BhBJ9Ids1vV7gpBVj7qvTl9BY-zFODbemFD1mSzIrfYQp_QIF8X0450-69wPJZMisCgmzbR0gog

### Test logging
GET http://mypi.local:9080/anything/test
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:121.0) Gecko/20100101 Firefox/121.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
DNT: 1
Connection: keep-alive
Cookie: session=iVdvRyuRBfjPQkcR7wrejg|1704953000|-2DAjLZ6rAgRqJbyRd_hWBhyLiav8bffBZyPjbzOpM25FPPoBUyYDDhWcnHIWNjg54O5JNYiCYkDsq9wCr2sBaMsayJM6IOA_0DCuJQk2Ozr1rtEHScfFVfZsC_5DBu40PxzTxyFbwNXfWFaWw0voFO6GIqvcuCM2m-T5HfgZmzBmEsxLHCVkwE9IzAnlTTyO1NSZThz0ExGIQKTeOXwJw6Ua1jCFHaBC8_HjpI9Ndk17s4wz7Z2MSBwu3TihWFjXeucXrZNxY6QilESQ-V-noD5p8xibRwOK7AmAIma4Yf1_l3jrhsHih73LJYnUvirAAPoFlsFqrhf50W1GhcS3lGEtd3qvr4SSSDUlAfAIW4kENkhYj7FHR74GT_kkObTJOyPqNHWhigbUUNGU5zO5yrobFH8LwFuL6SrrMDQiJ23hMHH4THLhvxijLeg2WEnT11ClfNB4gfuygFz0lKbBOrgPsrPe1a2S3XOA6TYWkbuk1i_stwdSpTGQBk7qsEBll55SFPuxVMSwHqgDn9jcwXxlIND7Uz2n7kNTdqaM55QfbGn-08b7klQPvliT_A9g7mcnzt_WDaaLKU7aCJZAvL-0E5sAALlTTlAgw3-IHPv9-65ZmdTAOO4bi3_sp01UUklA7xh7-zYUex61HjoYJDpPMIEFxGi3h6z0pqT12tMpSaUgVCtPP_nR5UxAmMu7Fxn_H9rq9MHTzNfUAMzxUKmSRZyKQhfjrDxZ2SsGzrC3Pu25UGdJ4higph-BwwupERxx9CfTL5pAGTfjA4QkMy9-ahOw0jjXkP7q-cyc0SnwZXXByzTuUXqXIhc3RnxUGvnf6pyEFoW_vcsjySeDTR3bTbKXb0W5ip-K8DVKnD3HvsRBFtmTHbiDswLywzdHUjZigpUHtu0NmSixAODtVpV9OH_tx3iErAWF3DXNqdiKWOKznxDdhQjRAp_6dO41kfZmVAfbd280Z_VWj4vlQKcTD39dxBIrmzvW8FWjjnbrddCzr9ES4GwA8hCS8MWNlyHlyvIqM2dYCn7oY_yAnJI33L2UnMEAckJKdl-rrW7E3a9lQvmU-H0xAVmFB9iUeEKwIVSQEHMoW_NC-x6axmg4OMl2pc-CxPwf7lpuRWiM492vjyEWO4aieA8OthFBooUTb08DpCcWEN_WsOJZ1sQq33pZ5hVgABb--mD3ECW6ZwBZ8w8SJUtZO3CZ6ZMSmPohPaSyuP-9uWdxpyQ9ihpEWDC78K3EowoYSic4h76AGs_Kx3aMu8L3ukeSj5nGFBHQRWmrntzH_t3zN0BbAax4xdmBZ27Xx1sQLc5VzXNQON6HNfdVv7p2WLOhzBGmrvzkh5sRbzqTVc8b8o1Thmf_BCz6MaZ4RjhssVjsI4_bb5ht2mV_vlxSDhkxblListEGO92TCgu3laIrXS0q3bYLfmqzOm3D9yCBf2fenCsIXfh8Jkex9pf-mJEWEZk-X2a5F-PZtvlnvma0WoDTJpPYFnm-aVD4mEnH2TAQ3UvRrRRVYo2_rxfbbOAnkY-Pyknrb04sAiN_DhW1Ul7rSUJX7MF2O1dHYRbVMkIbGxoJjNhoJOF3OJq91jP4YnuccTFiHFFRO4hWmoVg5f2jswESJ2HJ7ysbpM3_wLumCPe52qRMWfc58QM7FR4-onYW1VkjrGglthUGW-NLTTGtU8XBBuFGdiZ8Rdj0_uEM7aAfsav8-Ytj31isrtc5rkWeOAZxSrkBEOVJmBi1D0D3-b_lwVqYZnqcs4n6qmSafHZ4FFJm_jiN5bqOxwmBrkr5STOeyf3b6CLkaWo7VkETsUUqBx6mt7I_WPsCDh91FJZWQ7bGAbMERhJqzZhe_XxP0djRKviUrgL-Sj8CrwCoZ4-mrBF2t4euu08C_A2F3SxDK_ru_UDabsf_CKMwkfKF1FuVrYzo1xc7vecViaRv7rZY4_1LnbNpGoRXTQyQPot59YlDnxTSxd57FG3REt59W4QYA2ISHqT-nxJD6Su3GWCczYK5E7C4En32p-KvCDUnuX-oXeqap0BOIk70Mq9Gqndpw5IlnQsuVyMSbZgx33GYkpak4j4J-B_MGfMXDDj5VIB4nv8rDvCOY4cJs5QabYleOlGW3xkcYX7dZ5GxXAG-alFn3AFqOqg5BLaAXsv6H26kLzrt2hDrdFxLTnAHFlXp6Cf1snID4keEs7U_38K289UqnKSKutdbBET1cQKyJYTS4BWQTSE8LbbBfNefctEm7Q6isBDVCedOhq6ZpBzU0Kjn0NtOW5Xcb4V-oMUTk7QWmChxm06Y-Hk07lDXnTZnC79o3_bhAm0LNhGKItYSQVHcnAHaUCkdHWXeDrz5KRZCzce4k_VcDGdTZ4adC8Qk9QctTC1OwKl82uBgTHUuPRCQRc0CS3dXRcyy8PXhKftjsHaq8iYuH5C8NW2blyDvllx7V4tlDrX9zKobEb2jaB_KUgTyCK0dQ7qjNyQdXRz9iagqGhwMDWXD0b0aUpBAVIUi0UUIL7rbhXGS2EiBrwdBitRcvzIWTk08HaF9e97IOn8dRH1pKOm65qypCXwdHSb-lXVXPuGWcyC03NXHUUkJbGQaOugp28EhDu72ndprcvXO1E4BHxfkjB0ewaomSs6ELoMK56Vq9EcUPaTzUj3KyV5ttFURIP8aiXMjr5D5N0HpQqJy-9sFKTsyRjBAcyUwQp5bhLNd3SK0-8YeggmVt0NkSqV9Xu4MQILe3h0LiDtLNJ8cxU6PSqO-ip73w_uL7oA6h6-u4DShJPYeeRO5H7a_0DX4wIOUMPmRUm3nYmdyd9bjL_Dej3Q9AS_D7D48eDdRapz_a42w8v0nfnRL_wfYv9bfUhDyYEVYMFNHKHvQfD_IKgMOLhwhGriAQxob7jbYAKXnIYkzdr-ouLbchu48aS2T6KgLSe4suKR70uhJ_hFmvW7EbXU5HcfiCbwTYTUT6EQyR8nwfVJxjFM7CeWgkGGnfSIzPvhiqCLIAfsOca1UL9qEUc5wkJG_1tDk3L7Err1G1ngjTMizRFJcmK-0oPIz8jV231qgYRqUBdkiMEX8YV1BF-kF9gGvS-GbygQf-AFR67XoUrNmbTehQnmg-8hPGXXbO5to_6y0-LiYcliCqUwBbwIcl-Zn2TQIOsbFe4uUI9D9A8694nm0-3H6QzTKHmVVmQdJ56qaqC5XRWsnefdxsFD4cuE0mpdMsnVb8Lp-0IAZORE6yu0Ag3jMYxBljBf0gOFha-Vwhb85a70rg6rSB_TlDFSw7D-oRl526t6o4vKYMb5yxjJ1vn-WXCCh7S3y5QGJNhPYydt2yN24DJUZkUauXwQ091JaqQEg-cRe6_GuDq6SXBdkf3veHU7aL5lujPPajOCU9DHC8QVVaeauPs7tQ6Twg54TiMGdSJOx-zbhLICDLBvhR6aSCGg4AeKJ25F5fjQ5glByR9t7fsYkdrDleTlyl2at9aBCZpPqXHU_7F9JWb0Qw9Y6jfGBpVjEYOZLIE0_XXAyATaugEZdShWsd8bOyVk9-SG_EVYbdbA2O8j963eWvxPjr9lDXIbRQg1w8Ny2yWiND0dwaIOnN9Ywj3FA6GSrnOOoa8ZjbY5zl4KgQc0yQK2mxW0YsN7bCqrmIUYLxilZD95NpDyAoQ61YGSW2b0qP3fT2mM4f-sFud9f5zbe9BFh4h4FDkHsR8cRhTdQb94ju6PbJHF78_4zejhen_6NGC5rivqdhcrhRZTFtQllA1PebmbozXONQ8bKD52nEI7XyFQhmXMlKLS97--ZO9uJgmJLHLGZlt2Kbt_o-E2YK7r2GeK-vIeY0eyckGUemi9PVRVqbD7x3oS_9Ykk1Z-VlS5DfY_LLPLaJIjjo21-lV4Gb63Spoa5_bFUynpFMoq3fXcxNShUvltjbOiDZAXCIiHgP-fQYyJZWGh8v2I036yNuJ8--phqj_XMvDFzIRRr9jVc_p1VA0; session_2=L1QJ1g-S_MUuYnWKYaRg4hPUChZ1naEr9Vu2wQQ8sTWtQG97mT6PdjrO9JbkN8iQh0nrsEEiSEM_pls-Z8W4KHO7zYQcokkJ5SWN0TVhH13tjSBmncL4FTAvuWEtEN4eWeEPVaT1Y-NWGM44Ju_9KU7UZ-gjVRmPV-ZwFlLPxhSJdPjfLCLVm2cy8n2PEzHujj6BTe5WIUqt1IyvOqJCOHFTpwkhtdpipebZsN-pCMPBqSDa3fJPz0H5P0SSowCbIjbjqslFzteKfmqlRg3g0XkDyL14MnL8LYTOn4s5tq1nPkAwGxHLaqP2yH7-PAk6yhQKRleC5njhijeXvTo2YuGXKUbENdkJGXGPbxN14c3tpE6l4FpwbZFOMPvZbB-folly7ea2zNILc-iHSts6m3zv9cgYkHcKTR-kQ2hcxfS9r_DlGR7xofvVRLiMop7jZY4Y4L5D8YQDFUcX5Q7vAjbEFdX9lCjChp_9N49k_NKDvRb24WgICWo3ke4e54SlwljNRos97N-c9bFoJ_obvVxr-dOq3jy9Mgb5YQkYOjhnF-8Cj7184_jSIC112HNDFJ6k42nproHoge9kVLn7NzYymEcn1ae0UgOffx-2jGflMHuqOm_hnXGiCZmSYRoVWsU0vZMVYCVwKVUTtQLgu-tQUQk3stpk2edQGA_IWLC46qap4pSjLspJ82XpZRxFOretUzzDqtkfhY2UPaq9a-ST_TqeM1yaN2K8aA6EAydm3xXbN_thGqYK5obhLNq3lIaH0zTUrW-U1B0Lh_5_w5BHbPwT_W_a233ulqJxSomOLBRho1xkom8S2Ai-_Q2FIb9DYUB9Io6amRx-0fntPmpI12akqA708Ou14vNRLNVddlmG3ZBUD6l1RYm5G-h5hlKRMRnl2NcsM_g1Og937AEIDZHCcpLx127D2E5NEdJKAdozqWzI4XG6gddg508JQmQJtTwnJoGHTNFfgKxJoLtXYJbZDaUKBlD_kTG9-mOa1MrCYjNz2NAQcE_SsWivf4eAujfNBeY5HUbjEniTN8yq-Nqw1t6TP_vbCT-bdJBHzB4OwSp9lB4DcwJ_hqrW3-quJaQ49CiV2TewAl41-HnjxhYaPsRV2fdEEUDNN_VVKpjMLH3dXTBVbskN6UnEyS-N3BthitsK93GtotGq7Y1q5-LsWx9Bjt_X-e9bDDxovvyeTyeqRdDFC6m5zCQn7NfrvkweZKUQzCoU07Q_NYfHKJLZuj15eHM4Ws-ukk5mujvcBMSq211F3A9Pi2rWoJ34lWDnox98NcNIfiJqfQJJ3Hy4AKLYj2X58_TrK2Ph16T4oIcOROU1ibN8fyvUhn0CpjpqOUxbjXZyNprxoYQewxEczKDwU0qmJLAiop12cVg2SwIlPlHQ-GnUaytCsoNCcvVxm2-8Z_5ydtt3U0ullZN2AtdqTt5jYcqJLBApYWtHgBu1t4hSOWZ2iJjL29l8lOe2gvOcbAJINqyaXLMnUFq_jHzb_Kps-FT9d0oDOmBtT9RIoIlz7Fnt9ogCpFq9hBZZgk1pvd4BudkqxJlQFk8cAdzQ5pg_Lr9Z2mSJXhqOx7w_2hVL9ThzE_trZQ|vFbOnPVHnwkT--iaHRTiYWgouLw
Upgrade-Insecure-Requests: 1
Pragma: no-cache
Cache-Control: no-cache